# Live2D API 配置热重载使用说明

## 📋 概述

本项目已升级支持配置文件热重载功能，无需重启服务即可实时更新调试配置。

## 🔧 配置文件结构

### 主要配置项

```json
{
  "enabled": true,              // 总开关：是否启用调试功能
  "level": "info",             // 日志级别：debug < info < warn < error
  "logToFile": false,          // 是否将日志写入文件
  "logFilePath": "./logs/debug.log",  // 日志文件路径
  "showTimestamp": true,       // 是否显示时间戳
  "showLevel": true,           // 是否显示日志级别
  "colorOutput": true,         // 是否启用彩色输出
  
  "modules": {                 // 模块级别开关
    "server": true,            // 服务器相关日志
    "model": true,             // 模型加载相关日志
    "api": true,               // API请求相关日志
    "middleware": true,        // 中间件相关日志
    "webgl": true,             // WebGL相关日志
    "performance": true        // 性能监控日志
  },
  
  "performance": {             // 性能监控配置
    "trackRequests": true,     // 是否跟踪请求性能
    "trackMemory": true,       // 是否跟踪内存使用
    "trackCPU": false,         // 是否跟踪CPU使用
    "slowRequestThreshold": 1000  // 慢请求阈值(毫秒)
  },
  
  "api": {                     // API日志配置
    "logRequests": true,       // 是否记录请求
    "logResponses": false,     // 是否记录响应
    "logErrors": true,         // 是否记录错误
    "maxBodyLength": 1000      // 请求体最大记录长度
  }
}
```

## 🚀 热重载功能

### 如何使用

1. **启动服务**：正常启动 Live2D API 服务
2. **修改配置**：直接编辑 `config/debug.json` 文件
3. **保存文件**：保存后配置会自动重新加载
4. **立即生效**：无需重启服务，配置立即生效

### 实时调试示例

```bash
# 1. 启动服务
npm start

# 2. 在另一个终端修改配置
echo '{"enabled":true,"level":"debug","modules":{"api":true}}' > config/debug.json

# 3. 观察日志输出变化（自动生效）
```

## 🎯 常用配置场景

### 开发调试模式
```json
{
  "enabled": true,
  "level": "debug",
  "modules": {
    "server": true,
    "api": true,
    "performance": true
  },
  "performance": {
    "trackRequests": true,
    "trackMemory": true,
    "slowRequestThreshold": 500
  }
}
```

### 生产环境模式
```json
{
  "enabled": true,
  "level": "error",
  "modules": {
    "server": false,
    "api": false,
    "performance": false
  },
  "api": {
    "logErrors": true
  }
}
```

### 性能监控模式
```json
{
  "enabled": true,
  "level": "info",
  "modules": {
    "performance": true
  },
  "performance": {
    "trackRequests": true,
    "trackMemory": true,
    "slowRequestThreshold": 1000
  }
}
```

### API调试模式
```json
{
  "enabled": true,
  "level": "debug",
  "modules": {
    "api": true,
    "middleware": true
  },
  "api": {
    "logRequests": true,
    "logResponses": true,
    "logErrors": true,
    "maxBodyLength": 2000
  }
}
```

## 🐳 Docker 环境使用

### 配置文件挂载

在 Docker 环境中，配置文件通过卷挂载实现热重载：

```bash
# Docker 命令
docker run -v $(pwd)/config/debug.json:/app/config/debug.json live2d-api

# Docker Compose
volumes:
  - ./config/debug.json:/app/config/debug.json
```

### 容器内修改配置

```bash
# 方法1：直接修改宿主机文件
vim config/debug.json

# 方法2：进入容器修改
docker exec -it live2d-api vi /app/config/debug.json

# 方法3：使用 docker cp
echo '{"enabled":false}' > temp.json
docker cp temp.json live2d-api:/app/config/debug.json
```

## 📊 监控和日志

### 查看配置状态

服务启动时会显示当前配置状态：

```
[2024-01-01T12:00:00.000Z] [INFO] [server] 调试模式已启用 {"level":"info","modules":["server","api","performance"]}
[2024-01-01T12:00:00.000Z] [INFO] [server] 配置文件热重载已启用，修改 config/debug.json 将自动生效
```

### 配置变更通知

当配置文件发生变化时，会显示重载通知：

```
🔄 检测到debug配置文件变化，正在重新加载...
✅ Debug配置已加载: /app/config/debug.json
```

### 性能监控输出

启用性能监控后的输出示例：

```
[2024-01-01T12:00:00.000Z] [INFO] [api] GET /list - 45ms
[2024-01-01T12:00:30.000Z] [INFO] [performance] 内存使用情况 {"rss":"25.67 MB","heapTotal":"18.45 MB","heapUsed":"12.34 MB","external":"2.11 MB"}
[2024-01-01T12:01:00.000Z] [WARN] [performance] 慢请求检测: GET /model/complex.model.json - 1250ms
```

## 🔧 故障排除

### 配置不生效

1. **检查文件格式**：确保 JSON 格式正确
2. **检查文件权限**：确保应用有读取权限
3. **查看错误日志**：检查是否有解析错误

### 热重载失败

```bash
# 检查文件监听状态
lsof | grep debug.json

# 重启服务
docker restart live2d-api
```

### 配置文件损坏

如果配置文件损坏，系统会自动使用默认配置：

```
❌ 加载debug配置失败: Unexpected token in JSON
📝 已创建默认debug配置文件: /app/config/debug.json
```

## 💡 最佳实践

1. **渐进式调试**：从 `error` 级别开始，逐步降低到 `debug`
2. **模块化控制**：只启用需要调试的模块
3. **性能监控**：生产环境建议关闭详细的性能跟踪
4. **日志轮转**：启用文件日志时注意日志文件大小
5. **配置备份**：重要配置修改前先备份

## 📞 技术支持

如遇问题，请检查：
1. JSON 格式是否正确
2. 文件权限是否正确
3. 服务是否正常运行
4. Docker 卷挂载是否正确

更多信息请参考 `README-Docker.md` 文档。